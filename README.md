**آموزش وصل شدن به اینترنت آزاد با DNS TUNNELING و Iodine**

این رپو یک راهنمای کاربردی برای دسترسی به اینترنت آزاد از طریق DNS Tunneling با ابزار Iodine است. در این روش، داده‌ها به‌صورت نام‌های DNS رمزگذاری و ارسال شده و پاسخ‌ها شامل بسته‌های دریافتی‌اند. مرحله به مرحله توضیح داده شده. باتوجه به وضعیت شدید فیلترینگ لازم دونستم تا این روشو معرفی کنم تا کوچک ترین کمکی که از دستم برمیاد رو کرده باشم. 😄

## چی لازم داریم
- دوتا سرور لینوکسی: یکی ایران (Server1)، یکی خارج (Server2)
- یک دامنه واقعی (مثلا `example.com`)
- ابزارهای لازم روی هر دو سرور و کلاینت:
  ```bash
  sudo apt update
  sudo apt install build-essential pkg-config zlib1g-dev libudns-dev curl dnsutils tcpdump
  ```

---

## تنظیم دامنه 🌐
فرض کنید دامنه `example.com` داریم:

1. رکورد A (DNS only):
   ```
   ns.example.com. A SERVER2_IP
   ```
2. رکورد NS برای زیردامنه تونل:
   ```
   t.example.com. NS ns.example.com
   ```

> نکته:
> - دامنه کوتاه و قدیمی انتخاب کنید تا فضای بیشتری برای دیتا فراهم باشد.

---

## نصب و کامپایل Iodine ⚙️
```bash
git clone https://github.com/yarrick/iodine.git
cd iodine/src
make
sudo make install
```

---

## کانفیگ سرور 🖥️
روی Server2 اجرا کن:
```bash
sudo iodined -f -c -P secretpassword -l 0.0.0.0 192.168.99.1 t.example.com
```
- `-f`: لاگ توی ترمینال
- `-c`: چند کلاینت همزمان
- `-P`: رمز تونل
- `-l`: IP bind
- `192.168.99.1`: IP تونل
- `t.example.com`: زیردامنه

---

## کانفیگ کلاینت 💻
روی Server1 یا هر کلاینت دیگه:
```bash
sudo iodine -f -r -P secretpassword 8.8.4.4 t.example.com
```
- `-r`: فقط DNS mode (سرعت ~1 KB/s)
- بدون `-r`: raw UDP (تا ~30 Mbps توی LAN)
- میشه بجای 8.8.4.4 از هر dns دیگه ای استفاده کرد و اگر نوشته نشه این آپشن، به صورت دیفالت از اولین nameserver استفاده میشه.
- میشه برای انتخاب nameserver از آیپی سرور خارج نیز استفاده کرد اما در زمان فیلترینگ امکان ارتباط مستقیم با سرور وجود نداره.

---

## گزینه‌های مهم 🔧
| گزینه     | کارکرد                                          |
|-----------|--------------------------------------------------|
| `-f`      | foreground                                      |
| `-c`      | چند کلاینت همزمان                                |
| `-P pass` | رمز تونل                                        |
| `-l IP`   | IP bind سرور                                    |
| `-m size` | حداکثر fragment downstream                      |
| `-M size` | حداکثر طول hostname                             |
| `-T type` | نوع query (NULL, TXT, SRV, MX, CNAME, PRIVATE)   |
| `-O codec`| codec downstream (raw, base32, base64, base128)  |
| `-r`      | DNS-only mode                                   |
| `-L 0/1`  | lazy mode خاموش/روشن                             |
| `-I sec`  | فاصله ذرخواست ها (دیفالت ۵)                          |

---

## تست و عیب‌یابی 🔍
1. بررسی ایجاد رابط dns0:
   ```bash
   ip addr show dns0
   ```
2. اطمینان از پینگ به سرور تونل:
   ```bash
   ping 192.168.99.1 -I dns0
   ```
3. مشاهده ترافیک DNS:
   ```bash
   sudo tcpdump -n -i any udp port 53
   ```
4. خطای BADIP:
   - معمولا به دلیل تغییر IP از سوی سرور یا Time-to-Live پایین رخ می‌دهد.
   - استفاده از گزینه `-c` و افزایش `-I` ممکن است مشکل را کاهش دهد.

---

## چطور دامنه انتخاب کنیم؟
- دامنه باید کوتاه و کم‌خطا باشد تا بخش هشدار و داده در دامنه جا شود.
- دامنه‌های قدیمی‌تر اعتماد بیشتری در بین resolverها دارند.
- از کاراکترهای خاص (مثل `-` یا `_`) بپرهیزید.
- برای یافتن دامنه‌های مناسب می‌توانید از [domainhunter](https://github.com/threatexpress/domainhunter) استفاده کنید.

---

## بهینه‌سازی سرعت 🚀
- **Raw UDP**: تا ~30 Mbps تو LAN، اما معمولا مسدود
- **DNS-only**: حدود 1 KB/s (ممکنه تا 450 KB/s هم باشه)
- تنظیم دقیق `-m`/`-M` مهمه
- `-T NULL` یا `-T PRIVATE` برای بیشترین حجم
- `-L1` (lazy) تأخیر کم می‌کنه
- نصب [unbound](https://nlnetlabs.nl/projects/unbound/about/) روی کلاینت برای کاهش packet loss

---

## مثال tunnel-in-tunnel 🔄
> بهتره از روش هایی استفاده بشه که overhad و یا handshake کمتری نیاز دارند تا اتصال پایدار تر و سریعتر باشه.

- **SSH SOCKS**:
  ```bash
  ssh -N -D 1080 user@192.168.99.1
  curl --socks5-hostname 127.0.0.1:1080 http://example.com
  ```
- **WireGuard**:
  - سرور WG: روی `192.168.99.1:51820`
  - کلاینت: `AllowedIPs=0.0.0.0/0`, `Endpoint=192.168.99.1:51820`
- **XRay (VLESS)**:
  - استفاده از بخش `reverse` در x-ui

---

## مقایسه با روش‌های دیگر (ICMP, DoH)

- **ICMP Tunneling** (ptunnel): این روش هم مثل همین روش پکت ها رو داخل ریکوئست های ping به سمت سرور مقصد ارسال میکنه اما اخیرا تست های گرفته شده نشون میده که این روش هم در برخی مناطق مسدود شد. در هرصورت مسدود کردن ping اختلال کمتری روی انترنت ایجاد میکنه اما مسدود کردن dns باعث ایجاد اختلال شدید تر روی اینترنت میشه و احتمال داده میشه که این اتفاق نیفته هرچند از این سیستم فیتلرینگ و این حجم از اختلال بعید نیست که این اتفاق هم بیفته.
- **DNS-over-HTTPS (DoH)**: درخواست‌ها در HTTPS کپسوله می‌شوند؛ سرعت حدود 3–5 kbps با تأخیر بالاتر و پایداری کمتر.

> در ایران و در زمان «Iran Access» اخیر روش dns tunneling امکان‌پذیر بوده اما تضمینی برای ادامه‌دار بودنش وجود ندارد.

---

## منابع 📚
- Iodine: https://github.com/yarrick/iodine
- مستندات اصلی: https://code.kryo.se/iodine
- IP over DNS: https://github.com/LauraWartschinski/IPoverDNS
- Domain Hunter: https://github.com/threatexpress/domainhunter

---

## کاربردها و محدودیت‌ها 🌍
باتوجه به چیزایی که دیدم از این روش در کشور‌های دیگه یا برای هک و تست نفوذ و یا برای دسترسی به اینترنت در محیط‌هایی که نیازمند احراز هویت وای‌فای هستند مثل فرودگاه‌ها استفاده میشه. اما در ایران متأسفانه به دلیل فیلترینگ شدید، این روش بیشتر به عنوان راه دسترسی به اینترنت آزاد کاربرد پیدا کرده.

هرچند این روش مثل همه روش‌های دیگه برای دسترسی به اینترنت آزاد کار می‌کنه، اما امکان بسته شدن هم داره. با توجه به فیلترینگ‌های شدید، ممکنه حتی ارسال درخواست‌های DNS هم غیرممکن بشه و اگر این اتفاق بیفته، آخرین امیدها برای اینترنت آزاد از دست میره. عملاً بستن درخواست‌های DNS باعث اختلال شدید تو اینترنت میشه.

**آیا این روش قابل تشخیص هستش؟** بله، اما چجوریش توضیح داده نمیشه تا فیلترچی حداقل تا جایی که ممکنه این روش رو مسدود نکنه (یا دیرتر مسدود کنه). 

---

#                                                                                   اینترنت آزاد یا برای همه یا هیچکس! 🌐

> این توضیحات بر اساس تست‌ها و مقالات مختلف جمع‌آوری شده. اگه جایی اشکال دیدی یا ایده‌ای داری خوشحال می‌شیم issue بزنی یا پیشنهادت رو بدی تا همگی به اینترنت آزاد دسترسی داشته باشیم! ❤️

